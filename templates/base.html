<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>{{ SITE_NAME }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      body{background:{{ UI_BG_COLOR }};color:{{ UI_TEXT_COLOR }};font-family:Georgia,serif;margin:0}
      header{display:flex;gap:.6rem;align-items:center;padding:.6rem .8rem;background:#00000012}
      header img{height:48px}
      header a{color:inherit;text-decoration:none}
      header a:hover{text-decoration:underline}
      main{padding:.8rem 1rem}
      /* Modale */
      .modal-backdrop{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:999}
      .modal{max-width:min(900px,92vw);max-height:85vh;overflow:auto;background:#fff;color:#222;border-radius:10px;padding:16px 18px;box-shadow:0 10px 30px #0006}
      .modal header{background:none;gap:.4rem; padding:0; margin:0 0 .4rem 0}
      .modal .close{margin-left:auto;cursor:pointer;font-weight:bold}
      .guide-title{font-size:18px;margin:0}
      .hidden{display:none}

      /* Bloc : Style des villages dÃ©sactivÃ©s */
      .village-option.disabled {
        color: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>

  <script src="{{ url_for('static', filename='js/app.js') }}"></script>

  <!-- âœ… Ajout de la classe dynamique ici -->
  <body class="{{ page_class|default('') }}">

    <header>
      {% if BUREAU_LOGO_URL %}
        <img src="{{ BUREAU_LOGO_URL }}" alt="Logo">
      {% endif %}
      <b>{{ BUREAU_NAME }}</b> - {{ SITE_NAME }}

      {% if current_user.is_authenticated %}
        | <a href="{{ url_for('dashboard') }}">Tableau de bord</a>
        | <a href="{{ url_for('rapport') }}">Rapport</a>

        {% set role = current_user.role if current_user.is_authenticated else '' %}
        {% if role == 'marechal' %}
          | <a href="#" data-guide="marechal">ðŸ“˜ Guide marÃ©chal</a>
        {% elif role == 'prevot' %}
          | <a href="#" data-guide="prevot">ðŸ“˜ Guide prÃ©vÃ´t</a>
          | <a href="#" data-guide="marechal">ðŸ“˜ Guide marÃ©chal</a>
        {% endif %}

        | <a href="{{ url_for('logout') }}">DÃ©connexion</a>
      {% else %}
        | <a href="{{ url_for('login') }}">Connexion</a>
      {% endif %}
    </header>

    <main>
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul>
            {% for m in messages %}
              <li>{{ m }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <footer>
      <hr>
      <div>Pour toute information ou problÃ¨me, contactez IG : Agatha.isabella</div>
    </footer>

    <!-- Modale Guides -->
    <div id="guide-backdrop" class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="guide-title">
        <header>
          <h2 id="guide-title" class="guide-title">Guide</h2>
          <span id="guide-close" class="close" title="Fermer">âœ•</span>
        </header>
        <div id="guide-content">Chargementâ€¦</div>
      </div>
    </div>

    <script>
      (function () {
        const backdrop = document.getElementById('guide-backdrop');
        const content  = document.getElementById('guide-content');
        const titleEl  = document.getElementById('guide-title');
        const closeBtn = document.getElementById('guide-close');

        function openModal(audience, label){
          titleEl.textContent = label;
          content.innerHTML = "Chargementâ€¦";
          backdrop.style.display = "flex";

          fetch(`/guide/${audience}`, {credentials:'same-origin'})
            .then(r => {
              if(!r.ok) throw new Error("HTTP " + r.status);
              return r.text();
            })
            .then(html => { content.innerHTML = html; })
            .catch(err => {
              content.innerHTML = "<em>Impossible de charger le guide (" + err.message + ").</em>";
            });
        }

        function closeModal(){
          backdrop.style.display = "none";
          content.innerHTML = "";
        }

        document.addEventListener('click', (e) => {
          const link = e.target.closest('[data-guide]');
          if(link){
            e.preventDefault();
            const audience = link.getAttribute('data-guide');
            const label = audience === 'prevot' ? 'Guide prÃ©vÃ´t' : 'Guide marÃ©chal';
            openModal(audience, label);
          }
        });

        closeBtn.addEventListener('click', closeModal);
        backdrop.addEventListener('click', (e) => {
          if(e.target === backdrop) closeModal();
        });
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape' && backdrop.style.display === 'flex') closeModal();
        });
      })();
    </script>
  </body>
</html>
